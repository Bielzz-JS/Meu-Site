var data =  [
    {
        "month": 4,
        "profit": 571278.85,
        "territory": "Southeast"
    },
    {
        "month": 12,
        "profit": 538277.35,
        "territory": "Southeast"
    },
    {
        "month": 3,
        "profit": 531168.45,
        "territory": "Southeast"
    },
    {
        "month": 7,
        "profit": 518073.05,
        "territory": "Southeast"
    },
    {
        "month": 5,
        "profit": 509211.5,
        "territory": "Southeast"
    },
    {
        "month": 6,
        "profit": 495988.8,
        "territory": "Southeast"
    },
    {
        "month": 10,
        "profit": 495505.75,
        "territory": "Southeast"
    },
    {
        "month": 11,
        "profit": 494635,
        "territory": "Southeast"
    },
    {
        "month": 2,
        "profit": 488834.65,
        "territory": "Southeast"
    },
    {
        "month": 9,
        "profit": 478531.75,
        "territory": "Southeast"
    },
    {
        "month": 1,
        "profit": 463603.35,
        "territory": "Southeast"
    },
    {
        "month": 8,
        "profit": 449493.2,
        "territory": "Southeast"
    },
    {
        "month": 7,
        "profit": 402128.7,
        "territory": "Mideast"
    },
    {
        "month": 4,
        "profit": 380253.7,
        "territory": "Mideast"
    },
    {
        "month": 5,
        "profit": 377723.75,
        "territory": "Mideast"
    },
    {
        "month": 1,
        "profit": 360344.85,
        "territory": "Plains"
    },
    {
        "month": 7,
        "profit": 353190.6,
        "territory": "Plains"
    },
    {
        "month": 10,
        "profit": 346242.05,
        "territory": "Southwest"
    },
    {
        "month": 4,
        "profit": 340772,
        "territory": "Plains"
    },
    {
        "month": 8,
        "profit": 338103.1,
        "territory": "Mideast"
    },
    {
        "month": 3,
        "profit": 337669.7,
        "territory": "Southwest"
    },
    {
        "month": 7,
        "profit": 333289.2,
        "territory": "Southwest"
    },
    {
        "month": 6,
        "profit": 330042.2,
        "territory": "Plains"
    },
    {
        "month": 1,
        "profit": 328479.1,
        "territory": "Southwest"
    },
    {
        "month": 7,
        "profit": 326124.5,
        "territory": "Great Lakes"
    },
    {
        "month": 10,
        "profit": 324157.4,
        "territory": "Mideast"
    },
    {
        "month": 5,
        "profit": 320947.75,
        "territory": "Southwest"
    },
    {
        "month": 9,
        "profit": 319542.8,
        "territory": "Southwest"
    },
    {
        "month": 9,
        "profit": 316014.65,
        "territory": "Plains"
    },
    {
        "month": 12,
        "profit": 315855.7,
        "territory": "Mideast"
    },
    {
        "month": 1,
        "profit": 313236.65,
        "territory": "Mideast"
    },
    {
        "month": 5,
        "profit": 310254.2,
        "territory": "Plains"
    },
    {
        "month": 4,
        "profit": 309262.6,
        "territory": "Southwest"
    },
    {
        "month": 4,
        "profit": 305472.8,
        "territory": "Great Lakes"
    },
    {
        "month": 12,
        "profit": 304502.2,
        "territory": "Far West"
    },
    {
        "month": 6,
        "profit": 302779.75,
        "territory": "Mideast"
    },
    {
        "month": 2,
        "profit": 301181.65,
        "territory": "Mideast"
    },
    {
        "month": 10,
        "profit": 299099.65,
        "territory": "Plains"
    },
    {
        "month": 12,
        "profit": 295532.5,
        "territory": "Plains"
    },
    {
        "month": 9,
        "profit": 292267.8,
        "territory": "Mideast"
    },
    {
        "month": 3,
        "profit": 289264.7,
        "territory": "Far West"
    },
    {
        "month": 7,
        "profit": 288211.1,
        "territory": "Far West"
    },
    {
        "month": 4,
        "profit": 282558.4,
        "territory": "Far West"
    },
    {
        "month": 11,
        "profit": 282177.45,
        "territory": "Plains"
    },
    {
        "month": 11,
        "profit": 279259.25,
        "territory": "Mideast"
    },
    {
        "month": 10,
        "profit": 277386.2,
        "territory": "Far West"
    },
    {
        "month": 1,
        "profit": 273969.5,
        "territory": "Great Lakes"
    },
    {
        "month": 2,
        "profit": 273707.95,
        "territory": "Far West"
    },
    {
        "month": 2,
        "profit": 271512.75,
        "territory": "Plains"
    },
    {
        "month": 9,
        "profit": 271370.05,
        "territory": "Great Lakes"
    },
    {
        "month": 3,
        "profit": 267224.45,
        "territory": "Mideast"
    },
    {
        "month": 5,
        "profit": 266731.65,
        "territory": "Far West"
    },
    {
        "month": 3,
        "profit": 266312.9,
        "territory": "Great Lakes"
    },
    {
        "month": 10,
        "profit": 266200.65,
        "territory": "Great Lakes"
    },
    {
        "month": 6,
        "profit": 265657.5,
        "territory": "Southwest"
    },
    {
        "month": 12,
        "profit": 265299.85,
        "territory": "Southwest"
    },
    {
        "month": 11,
        "profit": 261974.15,
        "territory": "Great Lakes"
    },
    {
        "month": 8,
        "profit": 260395.1,
        "territory": "Plains"
    },
    {
        "month": 3,
        "profit": 260068.4,
        "territory": "Plains"
    },
    {
        "month": 2,
        "profit": 258053.95,
        "territory": "Southwest"
    },
    {
        "month": 2,
        "profit": 252274.5,
        "territory": "Great Lakes"
    },
    {
        "month": 12,
        "profit": 251794.5,
        "territory": "Great Lakes"
    },
    {
        "month": 11,
        "profit": 250538.05,
        "territory": "Southwest"
    },
    {
        "month": 8,
        "profit": 249355.25,
        "territory": "Southwest"
    },
    {
        "month": 5,
        "profit": 249226.3,
        "territory": "Great Lakes"
    },
    {
        "month": 6,
        "profit": 248196.35,
        "territory": "Far West"
    },
    {
        "month": 9,
        "profit": 247409.1,
        "territory": "Far West"
    },
    {
        "month": 1,
        "profit": 244124.95,
        "territory": "Far West"
    },
    {
        "month": 8,
        "profit": 226503.8,
        "territory": "Great Lakes"
    },
    {
        "month": 6,
        "profit": 218968.4,
        "territory": "Great Lakes"
    },
    {
        "month": 11,
        "profit": 217790.5,
        "territory": "Far West"
    },
    {
        "month": 7,
        "profit": 217199.1,
        "territory": "Rocky Mountain"
    },
    {
        "month": 8,
        "profit": 216669.9,
        "territory": "Far West"
    },
    {
        "month": 6,
        "profit": 179357.7,
        "territory": "Rocky Mountain"
    },
    {
        "month": 10,
        "profit": 173317,
        "territory": "Rocky Mountain"
    },
    {
        "month": 5,
        "profit": 169976.95,
        "territory": "Rocky Mountain"
    },
    {
        "month": 9,
        "profit": 160656.5,
        "territory": "Rocky Mountain"
    },
    {
        "month": 2,
        "profit": 156171.85,
        "territory": "Rocky Mountain"
    },
    {
        "month": 3,
        "profit": 153523,
        "territory": "Rocky Mountain"
    },
    {
        "month": 1,
        "profit": 145715.65,
        "territory": "Rocky Mountain"
    },
    {
        "month": 11,
        "profit": 134819.25,
        "territory": "Rocky Mountain"
    },
    {
        "month": 12,
        "profit": 130287.45,
        "territory": "Rocky Mountain"
    },
    {
        "month": 4,
        "profit": 129716.05,
        "territory": "Rocky Mountain"
    },
    {
        "month": 8,
        "profit": 122059.85,
        "territory": "New England"
    },
    {
        "month": 9,
        "profit": 119490.9,
        "territory": "New England"
    },
    {
        "month": 4,
        "profit": 119141.8,
        "territory": "New England"
    },
    {
        "month": 10,
        "profit": 116022.3,
        "territory": "New England"
    },
    {
        "month": 8,
        "profit": 109644.4,
        "territory": "Rocky Mountain"
    },
    {
        "month": 3,
        "profit": 108136.45,
        "territory": "New England"
    },
    {
        "month": 5,
        "profit": 105978.5,
        "territory": "New England"
    },
    {
        "month": 1,
        "profit": 95164.15,
        "territory": "New England"
    },
    {
        "month": 12,
        "profit": 92421.75,
        "territory": "New England"
    },
    {
        "month": 2,
        "profit": 87069.55,
        "territory": "New England"
    },
    {
        "month": 6,
        "profit": 86249.9,
        "territory": "New England"
    },
    {
        "month": 11,
        "profit": 85660.1,
        "territory": "New England"
    },
    {
        "month": 7,
        "profit": 85169.3,
        "territory": "New England"
    },
    {
        "month": 7,
        "profit": 37709.1,
        "territory": "External"
    },
    {
        "month": 5,
        "profit": 36586.45,
        "territory": "External"
    },
    {
        "month": 3,
        "profit": 34461.3,
        "territory": "External"
    },
    {
        "month": 6,
        "profit": 32653.25,
        "territory": "External"
    },
    {
        "month": 10,
        "profit": 30549,
        "territory": "External"
    },
    {
        "month": 9,
        "profit": 29205.7,
        "territory": "External"
    },
    {
        "month": 4,
        "profit": 26986.6,
        "territory": "External"
    },
    {
        "month": 1,
        "profit": 25575.15,
        "territory": "External"
    },
    {
        "month": 11,
        "profit": 23353.3,
        "territory": "External"
    },
    {
        "month": 2,
        "profit": 23276.1,
        "territory": "External"
    },
    {
        "month": 8,
        "profit": 22036.2,
        "territory": "External"
    },
    {
        "month": 12,
        "profit": 21015,
        "territory": "External"
    }
]

var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]

var ribbon = getRibbonList()

// Copyright 2021, Observable Inc.
// Released under the ISC license.
// https://observablehq.com/@d3/color-legend
function Swatches(color, {
    columns = null,
    format,
    unknown: formatUnknown,
    swatchSize = 30,
    swatchWidth = swatchSize,
    swatchHeight = swatchSize,
    marginLeft = 0
  } = {}) {
    const id = `-swatches-${Math.random().toString(16).slice(2)}`;
    const unknown = formatUnknown == null ? undefined : color.unknown();
    const unknowns = unknown == null || unknown === d3.scaleImplicit ? [] : [unknown];
    const domain = color.domain().concat(unknowns);
    if (format === undefined) format = x => x === unknown ? formatUnknown : x;
  
    function entity(character) {
      return `&#${character.charCodeAt(0).toString()};`;
    }
  
    if (columns !== null) return htl.html`<div style="display: flex; align-items: center; margin-left: ${+marginLeft}px; min-height: 33px; font: 10px sans-serif;">
    <style>
  
  .${id}-item {
    break-inside: avoid;
    display: flex;
    align-items: center;
    padding-bottom: 1px;
  }
  
  .${id}-label {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: calc(100% - ${+swatchWidth}px - 0.5em);
  }
  
  .${id}-swatch {
    width: ${+swatchWidth}px;
    height: ${+swatchHeight}px;
    margin: 0 0.5em 0 0;
  }
  
    </style>
    <div style=${{width: "100%", columns}}>${domain.map(value => {
      const label = `${format(value)}`;
      return htl.html`<div class=${id}-item>
        <div class=${id}-swatch style=${{background: color(value)}}></div>
        <div class=${id}-label title=${label}>${label}</div>
      </div>`;
    })}
    </div>
  </div>`;
  
    return htl.html`<div style="display: flex; align-items: center; min-height: 33px; margin-left: ${+marginLeft}px; font: 10px sans-serif;">
    <style>
  
  .${id} {
    display: inline-flex;
    align-items: center;
    margin-right: 1em;
  }
  
  .${id}::before {
    content: "";
    width: ${+swatchWidth}px;
    height: ${+swatchHeight}px;
    margin-right: 0.5em;
    background: var(--color);
  }
  
    </style>
    <div>${domain.map(value => htl.html`<span class="${id}" style="--color: ${color(value)}">${format(value)}</span>`)}</div>`;
}

function swatches({color, ...options}) {
    return Swatches(color, options);
}

fmt = n => d3.format(",d")(n)

wrap = (...elems) => {
    const div = document.createElement("div");
    elems.forEach(el => div.appendChild(el));
    return div;
}

function getRibbonList() {
    return d3.groups(data, d => d.month).sort((a, b) => a[0] - b[0]).flatMap(m => m[1].map((d, i) => ({...d, month: d.month - 1, rank: i + 1})))
}

addAnimation = (
    plot,
    { type = "circle", attribute = "fill-opacity", delay = 50, endValue = 1 } = {}
  ) => {
    const wrapper = d3.create("div");
    const chart = d3.select(plot);
    // Matching the camelCase of plot to the D3 attribute
    let attr;
    switch (attribute) {
      case "fillOpacity":
        attr = "fill-opacity";
        break;
      case "strokeOpacity":
        attr = "stroke-opacity";
        break;
      default:
        attr = attribute;
    }
  
    chart
      .selectAll(type)
      .transition()
      .duration(500)
      .delay((d, i) => i * delay)
      .style(attr, endValue)
      .attr(attr, endValue);
    
      console.log(chart.node())
    return chart.node();
  }

function getChart(){
    const territories = [...new Set(ribbon.map(d => d.territory))];
    const plot = Plot.plot({
      width: 1200,
      height: 600,
      x: {
        align: 0,    
        round: false,
        domain: months
      },
      y: {
        grid: true,
        label: "Profit",
        nice: true,
        tickFormat: d3.format(".2s")
      },
      color: {
        type: "categorical",
        domain: territories
      },
      marks: [   
        Plot.areaY(ribbon, Plot.stackY({
          x: d => months[d.month],
          y: "profit",
          curve: "bump-x",
          fill: "territory",      
          fillOpacity: 0,
          order: "value"
        })),
        Plot.barY(ribbon, Plot.stackY({
          x: d => months[d.month],
          y: "profit",
          fill: "territory",
          fillOpacity: 0,    
          order: "value",
          insetLeft: 15, 
          insetRight: 15,
          delay: 100,
          title: d => `${months[d.month]} - ${d.territory}\nRank: ${d.rank}\nProfit: ${fmt(d.profit)}`
        }))
      ]
    })

    addAnimation(plot, { type :"rect", attribute :"fill-opacity", delay :15, endValue:1 })
    addAnimation(plot, { type :"path", attribute :"fill-opacity", delay :60, endValue:0.7 })
    
    return wrap(
      swatches({color: d3.scaleOrdinal(territories, d3.schemeTableau10)}),
      plot
    )
}

id_generator = () => {
    var S4 = function () {
      return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
    };
    return "a" + S4() + S4();
}

hover = (tip, pos, text) => {
    const side_padding = 10;
    const vertical_padding = 5;
    const vertical_offset = 15;
  
    // Empty it out
    tip.selectAll("*").remove();
  
    // Append the text
    tip
      .style("text-anchor", "middle")
      .style("pointer-events", "none")
      .attr("transform", `translate(${pos[0]}, ${pos[1] + 7})`)
      .selectAll("text")
      .data(text)
      .join("text")
      .style("dominant-baseline", "ideographic")
      .text((d) => d)
      .attr("y", (d, i) => (i - (text.length - 1)) * 15 - vertical_offset)
      .style("font-weight", (d, i) => (i === 0 ? "bold" : "normal"));

    const bbox = tip.node().getBBox();
  
    // Add a rectangle (as background)
    tip
      .append("rect")
      .attr("y", bbox.y - vertical_padding)
      .attr("x", bbox.x - side_padding)
      .attr("width", bbox.width + side_padding * 2)
      .attr("height", bbox.height + vertical_padding * 2)
      .style("fill", "white")
      .style("stroke", "#d3d3d3")
      .lower();
}

addTooltips = (chart, styles) => {
    const stroke_styles = { stroke: "blue", "stroke-width": 3 };
    const fill_styles = { fill: "blue", opacity: 0.5 };
  
    // Workaround if it's in a figure
    const type = d3.select(chart).node().tagName;
    let wrapper =
      type === "FIGURE" ? d3.select(chart).select("svg") : d3.select(chart);
  
    // Workaround if there's a legend....
    const svgs = d3.select(chart).selectAll("svg");
    if (svgs.size() > 1) wrapper = d3.select([...svgs].pop());
    wrapper.style("overflow", "visible"); // to avoid clipping at the edges
  
    // Set pointer events to visibleStroke if the fill is none (e.g., if its a line)
    wrapper.selectAll("path").each(function (data, index, nodes) {
      // For line charts, set the pointer events to be visible stroke
      if (
        d3.select(this).attr("fill") === null ||
        d3.select(this).attr("fill") === "none"
      ) {
        d3.select(this).style("pointer-events", "visibleStroke");
        if (styles === undefined) styles = stroke_styles;
      }
    });
    
    if (styles === undefined) styles = fill_styles;
  
    const tip = wrapper
      .selectAll(".hover")
      .data([1])
      .join("g")
      .attr("class", "hover")
      .style("pointer-events", "none")
      .style("text-anchor", "middle");
  
    // Add a unique id to the chart for styling
    const id = id_generator();
  
    // Add the event listeners
    d3.select(chart).classed(id, true); // using a class selector so that it doesn't overwrite the ID
    wrapper.selectAll("title").each(function () {
      // Get the text out of the title, set it as an attribute on the parent, and remove it
      const title = d3.select(this); // title element that we want to remove
      const parent = d3.select(this.parentNode); // visual mark on the screen
      const t = title.text();
      if (t) {
        parent.attr("__title", t).classed("has-title", true);
        title.remove();
      }
      // Mouse events
      parent
        .on("pointerenter pointermove", function (event) {
          const text = d3.select(this).attr("__title");
          const pointer = d3.pointer(event, wrapper.node());
          if (text) tip.call(hover, pointer, text.split("\n"));
          else tip.selectAll("*").remove();
  
          // Raise it
          d3.select(this).raise();
          // Keep within the parent horizontally
          const tipSize = tip.node().getBBox();
          if (pointer[0] + tipSize.x < 0)
            tip.attr(
              "transform",
              `translate(${tipSize.width / 2}, ${pointer[1] + 7})`
            );
          else if (pointer[0] + tipSize.width / 2 > wrapper.attr("width"))
            tip.attr(
              "transform",
              `translate(${wrapper.attr("width") - tipSize.width / 2}, ${
                pointer[1] + 7
              })`
            );
        })
        .on("pointerout", function (event) {
          tip.selectAll("*").remove();
          // Lower it!
          d3.select(this).lower();
        });
    });
  
    // Remove the tip if you tap on the wrapper (for mobile)
    wrapper.on("touchstart", () => tip.selectAll("*").remove());
  
    // Define the styles
    chart.appendChild(htl.html`<style>
    .${id} .has-title { cursor: pointer;  pointer-events: all; }
    .${id} .has-title:hover { ${Object.entries(styles).map(([key, value]) => `${key}: ${value};`).join(" ")} }`);
  
    return chart;
}

var svg = d3.select("container")


document.getElementById('container').appendChild(addTooltips(getChart()))